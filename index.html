<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>迷雾森林 - Misty Forest</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 2rem;
      background-image: url('assets/background.png');
      background-size: cover;
      background-position: center;
      transition: opacity 0.5s ease;
    }

    body.loading {
      opacity: 0;
    }

    .container {
      background: rgba(0, 0, 0, 0.8);
      padding: 2rem;
      border-radius: 1rem;
      max-width: 600px;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }

    .story-text {
      font-size: 1.2rem;
      line-height: 1.6;
      opacity: 0;
      animation: fadeInText 0.8s ease forwards;
    }

    .choices {
      margin-top: 1.5rem;
    }

    .choices button,
    #restartBtn,
    #langBtn,
    #soundBtn stBtn,
    #langBtn,
    #soundBtn {
      margin: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      background-color: #4a4a4a;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s, transform 0.1s;
    }

    .choices button:hover,
    #restartBtn:hover,
    #langBtn:hover,
    #soundBtn:hover {
      background-color: #6a6a6a;
      transform: scale(1.05);
    }

    .choices button:focus,
    #restartBtn:focus,
    #langBtn:focus,
    #soundBtn:focus {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }

    #controls {
      margin-top: 1.5rem;
    }

    .end-message {
      font-style: italic;
      margin-top: 1rem;
      opacity: 0;
      animation: fadeInText 1s ease forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInText {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @media (prefers-contrast: high) {
      .container {
        background: rgba(0, 0, 0, 0.95);
      }

      .choices button,
      #restartBtn,
      #langBtn,
      #soundBtn {
        background-color: #333;
      }
    }
  </style>
</head>

<body class="loading">
  <div class="container" role="main">
    <div id="story" class="story-text" aria-live="polite"></div>
    <div class="choices" id="choices" role="navigation"></div>
    <div id="controls">
      <button id="restartBtn" aria-label="Restart the game">🔄 重新开始 / Restart</button>
      <button id="langBtn" aria-label="Toggle language">🌐 切换语言 / Toggle Language</button>
      <button id="soundBtn" aria-label="Toggle sound">🔊 声音 / Sound: <span id="soundStatus">On</span></button>
    </div>
  </div>

  <script>
    const storyData = {
      zh: {
        start: {
          text: "你醒来时，四周是浓雾，森林寂静得可怕。你手中有一个破旧的指南针。",
          choices: [
            { text: "跟着指南针走", next: "compassPath" },
            { text: "随意乱走", next: "randomPath" }
          ]
        },
        compassPath: {
          text: "你跟着指南针，小心避开倒下的树干，远处有微弱的光亮。",
          choices: [
            { text: "向光亮走", next: "safePath" },
            { text: "躲进树洞", next: "foxEncounter" }
          ]
        },
        foxEncounter: {
          text: "你遇到一只狐狸，它居然开口说话：‘别往那边走，那是猎人的陷阱。’",
          choices: [
            { text: "相信它", next: "foxEscape" },
            { text: "无视它", next: "hunterTrap" }
          ]
        },
        randomPath: {
          text: "你越走越远，雾越来越浓，四周变得模糊。",
          choices: [
            { text: "试图爬树观察", next: "treeView" },
            { text: "坐下来等待", next: "lostPath" }
          ]
        },
        safePath: {
          text: "你走向光亮，穿出森林的边界。你逃出了迷雾森林！（好结局）",
          choices: []
        },
        foxEscape: {
          text: "狐狸带你绕过陷阱，一路引导你走出了森林。你得救了！（神秘结局）",
          choices: []
        },
        hunterTrap: {
          text: "你掉进了猎人的陷阱……这是你的结局。（死亡结局）",
          choices: []
        },
        treeView: {
          text: "你看到了远处的火光，或许是出口……但你没力气走过去了。你迷失了。（迷失结局）",
          choices: [
            { text: "集中意志坚持前行", next: "torchPath" },
            { text: "回到地面，另找出路", next: "shadowWhispers" }
          ]
        },
        lostPath: {
          text: "你等待着……直到意识消失在黑暗中。",
          choices: [
            { text: "突然听见低语声", next: "shadowWhispers" },
            { text: "试图入睡恢复体力", next: "dreamWorld" }
          ]
        },
        torchPath: {
          text: "你咬牙坚持，走向火光。越靠近，你越能感受到一股温暖，但也伴随着低语声。",
          choices: [
            { text: "继续前进", next: "fireCamp" },
            { text: "躲起来观察", next: "strangerReveal" }
          ]
        },
        shadowWhispers: {
          text: "黑暗中传来呢喃，你分不清是幻觉还是有人在召唤你。",
          choices: [
            { text: "回应声音", next: "shadowRealm" },
            { text: "沉默不语，悄悄离开", next: "lostShrine" }
          ]
        },
        dreamWorld: {
          text: "你在梦中看见一个巨大的神殿，神殿中有一块发光的石板。",
          choices: [
            { text: "触碰石板", next: "ancientMemory" },
            { text: "忽略梦境，强迫自己醒来", next: "returnFog" }
          ]
        },
        fireCamp: {
          text: "你来到营火旁，一个披着斗篷的老人坐在那里，仿佛早已知道你会来。",
          choices: [
            { text: "坐下与他交谈", next: "forestTruth" },
            { text: "保持警惕，远离他", next: "ambushTrap" }
          ]
        },
        strangerReveal: {
          text: "你躲在树后，看到老人把一块光石扔进火里，火焰突然变色。",
          choices: [
            { text: "冲出去质问他", next: "forestTruth" },
            { text: "等待更多线索", next: "hiddenPast" }
          ]
        },
        shadowRealm: {
          text: "你被黑雾包围，眼前出现一个巨大的影子生物，它要求你回答一个谜题才能放你走。",
          choices: [
            { text: "尝试解谜", next: "riddleChallenge" },
            { text: "逃跑", next: "curseEnd" }
          ]
        },
        lostShrine: {
          text: "你发现了一个被藤蔓覆盖的古老祭坛，似乎蕴藏着某种力量。",
          choices: [
            { text: "献上你手中的指南针", next: "shrineBlessing" },
            { text: "转身离开", next: "forestLoop" }
          ]
        },
        ancientMemory: {
          text: "你触碰石板，记忆涌入脑海——你曾是这座森林的守护者之一。",
          choices: [
            { text: "接受使命", next: "guardianAwakening" },
            { text: "拒绝命运", next: "memoryCollapse" }
          ]
        },
        returnFog: {
          text: "你强行醒来，却发现森林变得更诡异，时间和空间似乎已经扭曲。",
          choices: [
            { text: "呼喊求救", next: "echoTrap" },
            { text: "继续前行", next: "timeLoop" }
          ]
        },

        // 结尾节点示例（可继续扩展）
        forestTruth: { text: "老人缓缓开口：‘森林选择了你……’（待续）", choices: [] },
        ambushTrap: { text: "一群影子突然扑来，你无法逃脱。（死亡结局）", choices: [] },
        hiddenPast: { text: "你听见他低声说着你曾经的名字……（神秘结局）", choices: [] },
        riddleChallenge: { text: "你聪明地回答了谜题，影子放你离开了。（好结局）", choices: [] },
        curseEnd: { text: "你逃跑失败，被诅咒缠绕，永远迷失。（诅咒结局）", choices: [] },
        shrineBlessing: { text: "指南针化为光芒，照亮出路，你获得祝福走出森林。（祝福结局）", choices: [] },
        forestLoop: { text: "你又回到了最初的起点，仿佛一切从未开始……（时间循环）", choices: [] },
        guardianAwakening: { text: "你成为新的守护者，森林不再让你离开……但你拥有力量。（守护者结局）", choices: [] },
        memoryCollapse: { text: "你拒绝使命，记忆崩塌，迷失于自我中……（失落结局）", choices: [] },
        echoTrap: { text: "你的呼喊吸引了它们……你再也无法逃离。（回音陷阱）", choices: [] },
        timeLoop: { text: "你陷入一个时间循环，每次醒来都回到森林深处……（循环结局）", choices: [] }
      },
      en: {
        start: {
          text: "You wake up surrounded by thick mist. The forest is eerily silent. You hold a worn-out compass.",
          choices: [
            { text: "Follow the compass", next: "compassPath" },
            { text: "Wander randomly", next: "randomPath" }
          ]
        },
        compassPath: {
          text: "You follow the compass, carefully stepping over fallen logs. There's a faint light in the distance.",
          choices: [
            { text: "Head toward the light", next: "safePath" },
            { text: "Hide in a tree hole", next: "foxEncounter" }
          ]
        },
        foxEncounter: {
          text: "You encounter a fox that suddenly speaks: 'Don't go that way. It's a hunter's trap.'",
          choices: [
            { text: "Trust the fox", next: "foxEscape" },
            { text: "Ignore it", next: "hunterTrap" }
          ]
        },
        randomPath: {
          text: "You wander deeper. The fog grows thicker. The world fades around you.",
          choices: [
            { text: "Climb a tree to see better", next: "treeView" },
            { text: "Sit and wait", next: "lostPath" }
          ]
        },
        safePath: {
          text: "You follow the light and reach the forest's edge. You're safe! (Good Ending)",
          choices: []
        },
        foxEscape: {
          text: "The fox guides you away from traps and leads you out of the forest. You're saved! (Mystery Ending)",
          choices: []
        },
        hunterTrap: {
          text: "You fall into the hunter's trap... This is your end. (Death Ending)",
          choices: []
        },
        treeView: {
          text: "You see a fire far away. Maybe an exit... but you're too weak to reach it. You're lost. (Lost Ending)",
          choices: [
            { text: "Gather your strength and press on", next: "torchPath" },
            { text: "Return to the ground and find another way", next: "shadowWhispers" }
          ]
        },
        lostPath: {
          text: "You wait... until the darkness takes your mind.",
          choices: [
            { text: "Suddenly hear whispers", next: "shadowWhispers" },
            { text: "Try to sleep and recover", next: "dreamWorld" }
          ]
        },
        torchPath: {
          text: "You grit your teeth and head toward the fire. The closer you get, the warmer it feels, but whispers echo around you.",
          choices: [
            { text: "Keep going", next: "fireCamp" },
            { text: "Hide and observe", next: "strangerReveal" }
          ]
        },
        shadowWhispers: {
          text: "Murmurs rise from the darkness. You can't tell if they're hallucinations or someone calling you.",
          choices: [
            { text: "Answer the whispers", next: "shadowRealm" },
            { text: "Stay silent and slip away", next: "lostShrine" }
          ]
        },
        dreamWorld: {
          text: "In a dream, you see a vast temple. A glowing stone tablet stands at its center.",
          choices: [
            { text: "Touch the tablet", next: "ancientMemory" },
            { text: "Ignore the dream and force yourself awake", next: "returnFog" }
          ]
        },
        fireCamp: {
          text: "You reach a campfire. An old man in a cloak sits there, as if he knew you were coming.",
          choices: [
            { text: "Sit and talk with him", next: "forestTruth" },
            { text: "Stay cautious and keep your distance", next: "ambushTrap" }
          ]
        },
        strangerReveal: {
          text: "From behind a tree, you see the old man toss a glowing stone into the fire, turning the flames a strange color.",
          choices: [
            { text: "Rush out and confront him", next: "forestTruth" },
            { text: "Wait for more clues", next: "hiddenPast" }
          ]
        },
        shadowRealm: {
          text: "Black mist surrounds you. A massive shadow creature appears, demanding you solve a riddle to pass.",
          choices: [
            { text: "Try to solve the riddle", next: "riddleChallenge" },
            { text: "Run away", next: "curseEnd" }
          ]
        },
        lostShrine: {
          text: "You find an ancient shrine covered in vines, radiating a strange power.",
          choices: [
            { text: "Offer your compass to the shrine", next: "shrineBlessing" },
            { text: "Turn and leave", next: "forestLoop" }
          ]
        },
        ancientMemory: {
          text: "You touch the tablet, and memories flood your mind—you were once a guardian of this forest.",
          choices: [
            { text: "Embrace your destiny", next: "guardianAwakening" },
            { text: "Reject your fate", next: "memoryCollapse" }
          ]
        },
        returnFog: {
          text: "You force yourself awake, but the forest feels stranger, as if time and space are warped.",
          choices: [
            { text: "Call out for help", next: "echoTrap" },
            { text: "Keep moving forward", next: "timeLoop" }
          ]
        },
        forestTruth: {
          text: "The old man speaks slowly: 'The forest chose you...' (To Be Continued)",
          choices: []
        },
        ambushTrap: {
          text: "Shadows lunge at you from the darkness. You can't escape. (Death Ending)",
          choices: []
        },
        hiddenPast: {
          text: "You hear him whisper your name from a forgotten past... (Mystery Ending)",
          choices: []
        },
        riddleChallenge: {
          text: "You cleverly solve the riddle, and the shadow lets you go. (Good Ending)",
          choices: []
        },
        curseEnd: {
          text: "You fail to escape and are bound by a curse, lost forever. (Curse Ending)",
          choices: []
        },
        shrineBlessing: {
          text: "Your compass turns to light, illuminating a path. You escape with a blessing. (Blessed Ending)",
          choices: []
        },
        forestLoop: {
          text: "You find yourself back at the start, as if nothing ever happened... (Time Loop)",
          choices: []
        },
        guardianAwakening: {
          text: "You become the forest's new guardian, never to leave, but wielding its power. (Guardian Ending)",
          choices: []
        },
        memoryCollapse: {
          text: "You reject your destiny, and your memories crumble. You lose yourself forever. (Fallen Ending)",
          choices: []
        },
        echoTrap: {
          text: "Your cries draw them in... You can never escape. (Echo Trap Ending)",
          choices: []
        },
        timeLoop: {
          text: "You're caught in a time loop, waking each time deep in the forest... (Loop Ending)",
          choices: []
        }
      }
    };

    const storyEl = document.getElementById('story');
    const choicesEl = document.getElementById('choices');
    const restartBtn = document.getElementById('restartBtn');
    const langBtn = document.getElementById('langBtn');
    const soundBtn = document.getElementById('soundBtn');
    const soundStatusEl = document.getElementById('soundStatus');

    let currentLang = localStorage.getItem('mistyForestLang') || 'zh';
    let isSoundOn = localStorage.getItem('mistyForestSound') !== 'off';
    const clickSound = new Audio('assets/click.mp3');
    clickSound.volume = 0.5;
    const ambientSound = new Audio('assets/ambient.mp3');
    ambientSound.loop = true;
    ambientSound.volume = 0.3;

    function preloadImage(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.src = url;
        img.onload = resolve;
        img.onerror = () => resolve();
      });
    }

    function showScene(sceneKey) {
      const scene = storyData[currentLang][sceneKey];
      storyEl.textContent = scene.text;
      choicesEl.innerHTML = '';

      if (scene.choices.length === 0) {
        const endMsg = document.createElement('p');
        endMsg.className = 'end-message';
        endMsg.textContent = currentLang === 'zh' ? '✨ 感谢你游玩这个故事！' : '✨ Thank you for playing!';
        choicesEl.appendChild(endMsg);
      } else {
        scene.choices.forEach((choice, index) => {
          const btn = document.createElement('button');
          btn.textContent = choice.text;
          btn.setAttribute('aria-label', choice.text);
          btn.tabIndex = index;
          btn.onclick = () => {
            if (isSoundOn) clickSound.play();
            showScene(choice.next);
          };
          choicesEl.appendChild(btn);
        });
      }
    }

    function toggleLanguage() {
      currentLang = currentLang === 'zh' ? 'en' : 'zh';
      localStorage.setItem('mistyForestLang', currentLang);
      if (isSoundOn) clickSound.play();
      showScene('start');
    }

    function toggleSound() {
      isSoundOn = !isSoundOn;
      soundStatusEl.textContent = isSoundOn ? 'On' : 'Off';
      localStorage.setItem('mistyForestSound', isSoundOn ? 'on' : 'off');
      if (isSoundOn) {
        clickSound.play();
        ambientSound.play();
      } else {
        ambientSound.pause();
      }
    }

    async function init() {
      await preloadImage('assets/background.png');
      document.body.classList.remove('loading');
      showScene('start');
      soundStatusEl.textContent = isSoundOn ? 'On' : 'Off';
      if (isSoundOn) ambientSound.play();
    }

    restartBtn.onclick = () => {
      if (isSoundOn) clickSound.play();
      showScene('start');
    };
    langBtn.onclick = toggleLanguage;
    soundBtn.onclick = toggleSound;

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        const focused = document.activeElement;
        if (focused.tagName === 'BUTTON') focused.click();
      }
    });

    init();
    window.addEventListener('click', () => {
      if (isSoundOn && ambientSound.paused) {
        ambientSound.play().catch(() => { });
      }
    }, { once: true });

  </script>
</body>

</html>