<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ëø∑ÈõæÊ£ÆÊûó - Misty Forest</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 2rem;
      background-image: url('assets/background.png');
      background-size: cover;
      background-position: center;
      transition: opacity 0.5s ease;
    }

    body.loading {
      opacity: 0;
    }

    .container {
      background: rgba(0, 0, 0, 0.8);
      padding: 2rem;
      border-radius: 1rem;
      max-width: 600px;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }

    .story-text {
      font-size: 1.2rem;
      line-height: 1.6;
      opacity: 0;
      animation: fadeInText 0.8s ease forwards;
    }

    .choices {
      margin-top: 1.5rem;
    }

    .choices button,
    #restartBtn,
    #langBtn,
    #soundBtn stBtn,
    #langBtn,
    #soundBtn {
      margin: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      background-color: #4a4a4a;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s, transform 0.1s;
    }

    .choices button:hover,
    #restartBtn:hover,
    #langBtn:hover,
    #soundBtn:hover {
      background-color: #6a6a6a;
      transform: scale(1.05);
    }

    .choices button:focus,
    #restartBtn:focus,
    #langBtn:focus,
    #soundBtn:focus {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }

    #controls {
      margin-top: 1.5rem;
    }

    .end-message {
      font-style: italic;
      margin-top: 1rem;
      opacity: 0;
      animation: fadeInText 1s ease forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInText {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @media (prefers-contrast: high) {
      .container {
        background: rgba(0, 0, 0, 0.95);
      }

      .choices button,
      #restartBtn,
      #langBtn,
      #soundBtn {
        background-color: #333;
      }
    }
  </style>
</head>

<body class="loading">
  <div class="container" role="main">
    <div id="story" class="story-text" aria-live="polite"></div>
    <div class="choices" id="choices" role="navigation"></div>
    <div id="controls">
      <button id="restartBtn" aria-label="Restart the game">üîÑ ÈáçÊñ∞ÂºÄÂßã / Restart</button>
      <button id="langBtn" aria-label="Toggle language">üåê ÂàáÊç¢ËØ≠Ë®Ä / Toggle Language</button>
      <button id="soundBtn" aria-label="Toggle sound">üîä Â£∞Èü≥ / Sound: <span id="soundStatus">On</span></button>
    </div>
  </div>

  <script>
    const storyData = {
      zh: {
        start: {
          text: "‰Ω†ÈÜíÊù•Êó∂ÔºåÂõõÂë®ÊòØÊµìÈõæÔºåÊ£ÆÊûóÂØÇÈùôÂæóÂèØÊÄï„ÄÇ‰Ω†Êâã‰∏≠Êúâ‰∏Ä‰∏™Á†¥ÊóßÁöÑÊåáÂçóÈíà„ÄÇ",
          choices: [
            { text: "Ë∑üÁùÄÊåáÂçóÈíàËµ∞", next: "compassPath" },
            { text: "ÈöèÊÑè‰π±Ëµ∞", next: "randomPath" }
          ]
        },
        compassPath: {
          text: "‰Ω†Ë∑üÁùÄÊåáÂçóÈíàÔºåÂ∞èÂøÉÈÅøÂºÄÂÄí‰∏ãÁöÑÊ†ëÂπ≤ÔºåËøúÂ§ÑÊúâÂæÆÂº±ÁöÑÂÖâ‰∫Æ„ÄÇ",
          choices: [
            { text: "ÂêëÂÖâ‰∫ÆËµ∞", next: "safePath" },
            { text: "Ë∫≤ËøõÊ†ëÊ¥û", next: "foxEncounter" }
          ]
        },
        foxEncounter: {
          text: "‰Ω†ÈÅáÂà∞‰∏ÄÂè™ÁãêÁã∏ÔºåÂÆÉÂ±ÖÁÑ∂ÂºÄÂè£ËØ¥ËØùÔºö‚ÄòÂà´ÂæÄÈÇ£ËæπËµ∞ÔºåÈÇ£ÊòØÁåé‰∫∫ÁöÑÈô∑Èò±„ÄÇ‚Äô",
          choices: [
            { text: "Áõ∏‰ø°ÂÆÉ", next: "foxEscape" },
            { text: "Êó†ËßÜÂÆÉ", next: "hunterTrap" }
          ]
        },
        randomPath: {
          text: "‰Ω†Ë∂äËµ∞Ë∂äËøúÔºåÈõæË∂äÊù•Ë∂äÊµìÔºåÂõõÂë®ÂèòÂæóÊ®°Á≥ä„ÄÇ",
          choices: [
            { text: "ËØïÂõæÁà¨Ê†ëËßÇÂØü", next: "treeView" },
            { text: "Âùê‰∏ãÊù•Á≠âÂæÖ", next: "lostPath" }
          ]
        },
        safePath: {
          text: "‰Ω†Ëµ∞ÂêëÂÖâ‰∫ÆÔºåÁ©øÂá∫Ê£ÆÊûóÁöÑËæπÁïå„ÄÇ‰Ω†ÈÄÉÂá∫‰∫ÜËø∑ÈõæÊ£ÆÊûóÔºÅÔºàÂ•ΩÁªìÂ±ÄÔºâ",
          choices: []
        },
        foxEscape: {
          text: "ÁãêÁã∏Â∏¶‰Ω†ÁªïËøáÈô∑Èò±Ôºå‰∏ÄË∑ØÂºïÂØº‰Ω†Ëµ∞Âá∫‰∫ÜÊ£ÆÊûó„ÄÇ‰Ω†ÂæóÊïë‰∫ÜÔºÅÔºàÁ•ûÁßòÁªìÂ±ÄÔºâ",
          choices: []
        },
        hunterTrap: {
          text: "‰Ω†ÊéâËøõ‰∫ÜÁåé‰∫∫ÁöÑÈô∑Èò±‚Ä¶‚Ä¶ËøôÊòØ‰Ω†ÁöÑÁªìÂ±Ä„ÄÇÔºàÊ≠ª‰∫°ÁªìÂ±ÄÔºâ",
          choices: []
        },
        treeView: {
          text: "‰Ω†ÁúãÂà∞‰∫ÜËøúÂ§ÑÁöÑÁÅ´ÂÖâÔºåÊàñËÆ∏ÊòØÂá∫Âè£‚Ä¶‚Ä¶‰ΩÜ‰Ω†Ê≤°ÂäõÊ∞îËµ∞ËøáÂéª‰∫Ü„ÄÇ‰Ω†Ëø∑Â§±‰∫Ü„ÄÇÔºàËø∑Â§±ÁªìÂ±ÄÔºâ",
          choices: [
            { text: "ÈõÜ‰∏≠ÊÑèÂøóÂùöÊåÅÂâçË°å", next: "torchPath" },
            { text: "ÂõûÂà∞Âú∞Èù¢ÔºåÂè¶ÊâæÂá∫Ë∑Ø", next: "shadowWhispers" }
          ]
        },
        lostPath: {
          text: "‰Ω†Á≠âÂæÖÁùÄ‚Ä¶‚Ä¶Áõ¥Âà∞ÊÑèËØÜÊ∂àÂ§±Âú®ÈªëÊöó‰∏≠„ÄÇ",
          choices: [
            { text: "Á™ÅÁÑ∂Âê¨ËßÅ‰ΩéËØ≠Â£∞", next: "shadowWhispers" },
            { text: "ËØïÂõæÂÖ•Áù°ÊÅ¢Â§ç‰ΩìÂäõ", next: "dreamWorld" }
          ]
        },
        torchPath: {
          text: "‰Ω†Âí¨ÁâôÂùöÊåÅÔºåËµ∞ÂêëÁÅ´ÂÖâ„ÄÇË∂äÈù†ËøëÔºå‰Ω†Ë∂äËÉΩÊÑüÂèóÂà∞‰∏ÄËÇ°Ê∏©ÊöñÔºå‰ΩÜ‰πü‰º¥ÈöèÁùÄ‰ΩéËØ≠Â£∞„ÄÇ",
          choices: [
            { text: "ÁªßÁª≠ÂâçËøõ", next: "fireCamp" },
            { text: "Ë∫≤Ëµ∑Êù•ËßÇÂØü", next: "strangerReveal" }
          ]
        },
        shadowWhispers: {
          text: "ÈªëÊöó‰∏≠‰º†Êù•Âë¢ÂñÉÔºå‰Ω†ÂàÜ‰∏çÊ∏ÖÊòØÂπªËßâËøòÊòØÊúâ‰∫∫Âú®Âè¨Âî§‰Ω†„ÄÇ",
          choices: [
            { text: "ÂõûÂ∫îÂ£∞Èü≥", next: "shadowRealm" },
            { text: "Ê≤âÈªò‰∏çËØ≠ÔºåÊÇÑÊÇÑÁ¶ªÂºÄ", next: "lostShrine" }
          ]
        },
        dreamWorld: {
          text: "‰Ω†Âú®Ê¢¶‰∏≠ÁúãËßÅ‰∏Ä‰∏™Â∑®Â§ßÁöÑÁ•ûÊÆøÔºåÁ•ûÊÆø‰∏≠Êúâ‰∏ÄÂùóÂèëÂÖâÁöÑÁü≥Êùø„ÄÇ",
          choices: [
            { text: "Ëß¶Á¢∞Áü≥Êùø", next: "ancientMemory" },
            { text: "ÂøΩÁï•Ê¢¶Â¢ÉÔºåÂº∫Ëø´Ëá™Â∑±ÈÜíÊù•", next: "returnFog" }
          ]
        },
        fireCamp: {
          text: "‰Ω†Êù•Âà∞Ëê•ÁÅ´ÊóÅÔºå‰∏Ä‰∏™Êä´ÁùÄÊñóÁØ∑ÁöÑËÄÅ‰∫∫ÂùêÂú®ÈÇ£ÈáåÔºå‰ªø‰ΩõÊó©Â∑≤Áü•ÈÅì‰Ω†‰ºöÊù•„ÄÇ",
          choices: [
            { text: "Âùê‰∏ã‰∏é‰ªñ‰∫§Ë∞à", next: "forestTruth" },
            { text: "‰øùÊåÅË≠¶ÊÉïÔºåËøúÁ¶ª‰ªñ", next: "ambushTrap" }
          ]
        },
        strangerReveal: {
          text: "‰Ω†Ë∫≤Âú®Ê†ëÂêéÔºåÁúãÂà∞ËÄÅ‰∫∫Êää‰∏ÄÂùóÂÖâÁü≥ÊâîËøõÁÅ´ÈáåÔºåÁÅ´ÁÑ∞Á™ÅÁÑ∂ÂèòËâ≤„ÄÇ",
          choices: [
            { text: "ÂÜ≤Âá∫ÂéªË¥®ÈóÆ‰ªñ", next: "forestTruth" },
            { text: "Á≠âÂæÖÊõ¥Â§öÁ∫øÁ¥¢", next: "hiddenPast" }
          ]
        },
        shadowRealm: {
          text: "‰Ω†Ë¢´ÈªëÈõæÂåÖÂõ¥ÔºåÁúºÂâçÂá∫Áé∞‰∏Ä‰∏™Â∑®Â§ßÁöÑÂΩ±Â≠êÁîüÁâ©ÔºåÂÆÉË¶ÅÊ±Ç‰Ω†ÂõûÁ≠î‰∏Ä‰∏™Ë∞úÈ¢òÊâçËÉΩÊîæ‰Ω†Ëµ∞„ÄÇ",
          choices: [
            { text: "Â∞ùËØïËß£Ë∞ú", next: "riddleChallenge" },
            { text: "ÈÄÉË∑ë", next: "curseEnd" }
          ]
        },
        lostShrine: {
          text: "‰Ω†ÂèëÁé∞‰∫Ü‰∏Ä‰∏™Ë¢´Ëó§ËîìË¶ÜÁõñÁöÑÂè§ËÄÅÁ•≠ÂùõÔºå‰ºº‰πéËï¥ËóèÁùÄÊüêÁßçÂäõÈáè„ÄÇ",
          choices: [
            { text: "ÁåÆ‰∏ä‰Ω†Êâã‰∏≠ÁöÑÊåáÂçóÈíà", next: "shrineBlessing" },
            { text: "ËΩ¨Ë∫´Á¶ªÂºÄ", next: "forestLoop" }
          ]
        },
        ancientMemory: {
          text: "‰Ω†Ëß¶Á¢∞Áü≥ÊùøÔºåËÆ∞ÂøÜÊ∂åÂÖ•ËÑëÊµ∑‚Äî‚Äî‰Ω†ÊõæÊòØËøôÂ∫ßÊ£ÆÊûóÁöÑÂÆàÊä§ËÄÖ‰πã‰∏Ä„ÄÇ",
          choices: [
            { text: "Êé•Âèó‰ΩøÂëΩ", next: "guardianAwakening" },
            { text: "ÊãíÁªùÂëΩËøê", next: "memoryCollapse" }
          ]
        },
        returnFog: {
          text: "‰Ω†Âº∫Ë°åÈÜíÊù•ÔºåÂç¥ÂèëÁé∞Ê£ÆÊûóÂèòÂæóÊõ¥ËØ°ÂºÇÔºåÊó∂Èó¥ÂíåÁ©∫Èó¥‰ºº‰πéÂ∑≤ÁªèÊâ≠Êõ≤„ÄÇ",
          choices: [
            { text: "ÂëºÂñäÊ±ÇÊïë", next: "echoTrap" },
            { text: "ÁªßÁª≠ÂâçË°å", next: "timeLoop" }
          ]
        },

        // ÁªìÂ∞æËäÇÁÇπÁ§∫‰æãÔºàÂèØÁªßÁª≠Êâ©Â±ïÔºâ
        forestTruth: { text: "ËÄÅ‰∫∫ÁºìÁºìÂºÄÂè£Ôºö‚ÄòÊ£ÆÊûóÈÄâÊã©‰∫Ü‰Ω†‚Ä¶‚Ä¶‚ÄôÔºàÂæÖÁª≠Ôºâ", choices: [] },
        ambushTrap: { text: "‰∏ÄÁæ§ÂΩ±Â≠êÁ™ÅÁÑ∂ÊâëÊù•Ôºå‰Ω†Êó†Ê≥ïÈÄÉËÑ±„ÄÇÔºàÊ≠ª‰∫°ÁªìÂ±ÄÔºâ", choices: [] },
        hiddenPast: { text: "‰Ω†Âê¨ËßÅ‰ªñ‰ΩéÂ£∞ËØ¥ÁùÄ‰Ω†ÊõæÁªèÁöÑÂêçÂ≠ó‚Ä¶‚Ä¶ÔºàÁ•ûÁßòÁªìÂ±ÄÔºâ", choices: [] },
        riddleChallenge: { text: "‰Ω†ËÅ™ÊòéÂú∞ÂõûÁ≠î‰∫ÜË∞úÈ¢òÔºåÂΩ±Â≠êÊîæ‰Ω†Á¶ªÂºÄ‰∫Ü„ÄÇÔºàÂ•ΩÁªìÂ±ÄÔºâ", choices: [] },
        curseEnd: { text: "‰Ω†ÈÄÉË∑ëÂ§±Ë¥•ÔºåË¢´ËØÖÂííÁº†ÁªïÔºåÊ∞∏ËøúËø∑Â§±„ÄÇÔºàËØÖÂííÁªìÂ±ÄÔºâ", choices: [] },
        shrineBlessing: { text: "ÊåáÂçóÈíàÂåñ‰∏∫ÂÖâËäíÔºåÁÖß‰∫ÆÂá∫Ë∑ØÔºå‰Ω†Ëé∑ÂæóÁ•ùÁ¶èËµ∞Âá∫Ê£ÆÊûó„ÄÇÔºàÁ•ùÁ¶èÁªìÂ±ÄÔºâ", choices: [] },
        forestLoop: { text: "‰Ω†ÂèàÂõûÂà∞‰∫ÜÊúÄÂàùÁöÑËµ∑ÁÇπÔºå‰ªø‰Ωõ‰∏ÄÂàá‰ªéÊú™ÂºÄÂßã‚Ä¶‚Ä¶ÔºàÊó∂Èó¥Âæ™ÁéØÔºâ", choices: [] },
        guardianAwakening: { text: "‰Ω†Êàê‰∏∫Êñ∞ÁöÑÂÆàÊä§ËÄÖÔºåÊ£ÆÊûó‰∏çÂÜçËÆ©‰Ω†Á¶ªÂºÄ‚Ä¶‚Ä¶‰ΩÜ‰Ω†Êã•ÊúâÂäõÈáè„ÄÇÔºàÂÆàÊä§ËÄÖÁªìÂ±ÄÔºâ", choices: [] },
        memoryCollapse: { text: "‰Ω†ÊãíÁªù‰ΩøÂëΩÔºåËÆ∞ÂøÜÂ¥©Â°åÔºåËø∑Â§±‰∫éËá™Êàë‰∏≠‚Ä¶‚Ä¶ÔºàÂ§±ËêΩÁªìÂ±ÄÔºâ", choices: [] },
        echoTrap: { text: "‰Ω†ÁöÑÂëºÂñäÂê∏Âºï‰∫ÜÂÆÉ‰ª¨‚Ä¶‚Ä¶‰Ω†ÂÜç‰πüÊó†Ê≥ïÈÄÉÁ¶ª„ÄÇÔºàÂõûÈü≥Èô∑Èò±Ôºâ", choices: [] },
        timeLoop: { text: "‰Ω†Èô∑ÂÖ•‰∏Ä‰∏™Êó∂Èó¥Âæ™ÁéØÔºåÊØèÊ¨°ÈÜíÊù•ÈÉΩÂõûÂà∞Ê£ÆÊûóÊ∑±Â§Ñ‚Ä¶‚Ä¶ÔºàÂæ™ÁéØÁªìÂ±ÄÔºâ", choices: [] }
      },
      en: {
        start: {
          text: "You wake up surrounded by thick mist. The forest is eerily silent. You hold a worn-out compass.",
          choices: [
            { text: "Follow the compass", next: "compassPath" },
            { text: "Wander randomly", next: "randomPath" }
          ]
        },
        compassPath: {
          text: "You follow the compass, carefully stepping over fallen logs. There's a faint light in the distance.",
          choices: [
            { text: "Head toward the light", next: "safePath" },
            { text: "Hide in a tree hole", next: "foxEncounter" }
          ]
        },
        foxEncounter: {
          text: "You encounter a fox that suddenly speaks: 'Don't go that way. It's a hunter's trap.'",
          choices: [
            { text: "Trust the fox", next: "foxEscape" },
            { text: "Ignore it", next: "hunterTrap" }
          ]
        },
        randomPath: {
          text: "You wander deeper. The fog grows thicker. The world fades around you.",
          choices: [
            { text: "Climb a tree to see better", next: "treeView" },
            { text: "Sit and wait", next: "lostPath" }
          ]
        },
        safePath: {
          text: "You follow the light and reach the forest's edge. You're safe! (Good Ending)",
          choices: []
        },
        foxEscape: {
          text: "The fox guides you away from traps and leads you out of the forest. You're saved! (Mystery Ending)",
          choices: []
        },
        hunterTrap: {
          text: "You fall into the hunter's trap... This is your end. (Death Ending)",
          choices: []
        },
        treeView: {
          text: "You see a fire far away. Maybe an exit... but you're too weak to reach it. You're lost. (Lost Ending)",
          choices: [
            { text: "Gather your strength and press on", next: "torchPath" },
            { text: "Return to the ground and find another way", next: "shadowWhispers" }
          ]
        },
        lostPath: {
          text: "You wait... until the darkness takes your mind.",
          choices: [
            { text: "Suddenly hear whispers", next: "shadowWhispers" },
            { text: "Try to sleep and recover", next: "dreamWorld" }
          ]
        },
        torchPath: {
          text: "You grit your teeth and head toward the fire. The closer you get, the warmer it feels, but whispers echo around you.",
          choices: [
            { text: "Keep going", next: "fireCamp" },
            { text: "Hide and observe", next: "strangerReveal" }
          ]
        },
        shadowWhispers: {
          text: "Murmurs rise from the darkness. You can't tell if they're hallucinations or someone calling you.",
          choices: [
            { text: "Answer the whispers", next: "shadowRealm" },
            { text: "Stay silent and slip away", next: "lostShrine" }
          ]
        },
        dreamWorld: {
          text: "In a dream, you see a vast temple. A glowing stone tablet stands at its center.",
          choices: [
            { text: "Touch the tablet", next: "ancientMemory" },
            { text: "Ignore the dream and force yourself awake", next: "returnFog" }
          ]
        },
        fireCamp: {
          text: "You reach a campfire. An old man in a cloak sits there, as if he knew you were coming.",
          choices: [
            { text: "Sit and talk with him", next: "forestTruth" },
            { text: "Stay cautious and keep your distance", next: "ambushTrap" }
          ]
        },
        strangerReveal: {
          text: "From behind a tree, you see the old man toss a glowing stone into the fire, turning the flames a strange color.",
          choices: [
            { text: "Rush out and confront him", next: "forestTruth" },
            { text: "Wait for more clues", next: "hiddenPast" }
          ]
        },
        shadowRealm: {
          text: "Black mist surrounds you. A massive shadow creature appears, demanding you solve a riddle to pass.",
          choices: [
            { text: "Try to solve the riddle", next: "riddleChallenge" },
            { text: "Run away", next: "curseEnd" }
          ]
        },
        lostShrine: {
          text: "You find an ancient shrine covered in vines, radiating a strange power.",
          choices: [
            { text: "Offer your compass to the shrine", next: "shrineBlessing" },
            { text: "Turn and leave", next: "forestLoop" }
          ]
        },
        ancientMemory: {
          text: "You touch the tablet, and memories flood your mind‚Äîyou were once a guardian of this forest.",
          choices: [
            { text: "Embrace your destiny", next: "guardianAwakening" },
            { text: "Reject your fate", next: "memoryCollapse" }
          ]
        },
        returnFog: {
          text: "You force yourself awake, but the forest feels stranger, as if time and space are warped.",
          choices: [
            { text: "Call out for help", next: "echoTrap" },
            { text: "Keep moving forward", next: "timeLoop" }
          ]
        },
        forestTruth: {
          text: "The old man speaks slowly: 'The forest chose you...' (To Be Continued)",
          choices: []
        },
        ambushTrap: {
          text: "Shadows lunge at you from the darkness. You can't escape. (Death Ending)",
          choices: []
        },
        hiddenPast: {
          text: "You hear him whisper your name from a forgotten past... (Mystery Ending)",
          choices: []
        },
        riddleChallenge: {
          text: "You cleverly solve the riddle, and the shadow lets you go. (Good Ending)",
          choices: []
        },
        curseEnd: {
          text: "You fail to escape and are bound by a curse, lost forever. (Curse Ending)",
          choices: []
        },
        shrineBlessing: {
          text: "Your compass turns to light, illuminating a path. You escape with a blessing. (Blessed Ending)",
          choices: []
        },
        forestLoop: {
          text: "You find yourself back at the start, as if nothing ever happened... (Time Loop)",
          choices: []
        },
        guardianAwakening: {
          text: "You become the forest's new guardian, never to leave, but wielding its power. (Guardian Ending)",
          choices: []
        },
        memoryCollapse: {
          text: "You reject your destiny, and your memories crumble. You lose yourself forever. (Fallen Ending)",
          choices: []
        },
        echoTrap: {
          text: "Your cries draw them in... You can never escape. (Echo Trap Ending)",
          choices: []
        },
        timeLoop: {
          text: "You're caught in a time loop, waking each time deep in the forest... (Loop Ending)",
          choices: []
        }
      }
    };

    const storyEl = document.getElementById('story');
    const choicesEl = document.getElementById('choices');
    const restartBtn = document.getElementById('restartBtn');
    const langBtn = document.getElementById('langBtn');
    const soundBtn = document.getElementById('soundBtn');
    const soundStatusEl = document.getElementById('soundStatus');

    let currentLang = localStorage.getItem('mistyForestLang') || 'zh';
    let isSoundOn = localStorage.getItem('mistyForestSound') !== 'off';
    const clickSound = new Audio('assets/click.mp3');
    clickSound.volume = 0.5;
    const ambientSound = new Audio('assets/ambient.mp3');
    ambientSound.loop = true;
    ambientSound.volume = 0.3;

    function preloadImage(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.src = url;
        img.onload = resolve;
        img.onerror = () => resolve();
      });
    }

    function showScene(sceneKey) {
      const scene = storyData[currentLang][sceneKey];
      storyEl.textContent = scene.text;
      choicesEl.innerHTML = '';

      if (scene.choices.length === 0) {
        const endMsg = document.createElement('p');
        endMsg.className = 'end-message';
        endMsg.textContent = currentLang === 'zh' ? '‚ú® ÊÑüË∞¢‰Ω†Ê∏∏Áé©Ëøô‰∏™ÊïÖ‰∫ãÔºÅ' : '‚ú® Thank you for playing!';
        choicesEl.appendChild(endMsg);
      } else {
        scene.choices.forEach((choice, index) => {
          const btn = document.createElement('button');
          btn.textContent = choice.text;
          btn.setAttribute('aria-label', choice.text);
          btn.tabIndex = index;
          btn.onclick = () => {
            if (isSoundOn) clickSound.play();
            showScene(choice.next);
          };
          choicesEl.appendChild(btn);
        });
      }
    }

    function toggleLanguage() {
      currentLang = currentLang === 'zh' ? 'en' : 'zh';
      localStorage.setItem('mistyForestLang', currentLang);
      if (isSoundOn) clickSound.play();
      showScene('start');
    }

    function toggleSound() {
      isSoundOn = !isSoundOn;
      soundStatusEl.textContent = isSoundOn ? 'On' : 'Off';
      localStorage.setItem('mistyForestSound', isSoundOn ? 'on' : 'off');
      if (isSoundOn) {
        clickSound.play();
        ambientSound.play();
      } else {
        ambientSound.pause();
      }
    }

    async function init() {
      await preloadImage('assets/background.png');
      document.body.classList.remove('loading');
      showScene('start');
      soundStatusEl.textContent = isSoundOn ? 'On' : 'Off';
      if (isSoundOn) ambientSound.play();
    }

    restartBtn.onclick = () => {
      if (isSoundOn) clickSound.play();
      showScene('start');
    };
    langBtn.onclick = toggleLanguage;
    soundBtn.onclick = toggleSound;

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        const focused = document.activeElement;
        if (focused.tagName === 'BUTTON') focused.click();
      }
    });

    init();
    window.addEventListener('click', () => {
      if (isSoundOn && ambientSound.paused) {
        ambientSound.play().catch(() => { });
      }
    }, { once: true });

  </script>
</body>

</html>